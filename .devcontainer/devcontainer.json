// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/ubuntu
{
    "name": "devbox",
    "image": "mcr.microsoft.com/devcontainers/base:noble",
    "runArgs": [
        "--env",
        "UV_LINK_MODE=copy",
        "--env",
        "UV_ENV_FILE=.env",
        "--env",
        "DOCKER_BUILDKIT=1",
        // "--env-file",
        // "./.devcontainer/devcontainer.env",
        "--name=${localWorkspaceFolderBasename}"
        // "--rm"
    ],
    "containerEnv": {
        "DOCKER_BUILDKIT": "1",
        "COMPOSE_DOCKER_CLI_BUILD": "1"
    },
    "features": {
        "ghcr.io/rocker-org/devcontainer-features/apt-packages:1": {
            "packages": "curl,ca-certificates,gnupg2,vim,jq",
            "upgradePackages": true
        },
        "ghcr.io/devcontainers/features/common-utils:2": {
            "installZsh": true,
            "configureZshAsDefaultShell": true,
            "installOhMyZsh": true
        },
        "ghcr.io/devcontainers-extra/features/zsh-plugins:0": {
            "omzPlugins": "zsh-users/zsh-autosuggestions,zdharma-continuum/fast-syntax-highlighting,zdharma-continuum/history-search-multi-word,chrissicool/zsh-256color"
        },
        "ghcr.io/devcontainers/features/git:1": {},
        "ghcr.io/devcontainers/features/python:1": {
            "version": "3.14",
            "toolsToInstall": "pre-commit"
        },
        "ghcr.io/devcontainers/features/node:1": {
            "version": "24.12.0"
        },
        "ghcr.io/devcontainers/features/rust:1": {
            "version": "latest"
        },
        "ghcr.io/devcontainers/features/aws-cli:1": {},
        "ghcr.io/devcontainers/features/azure-cli:1": {},
        // "ghcr.io/devcontainers/features/terraform:1": {
        //     "version": "latest"
        // },
        "ghcr.io/devcontainers-extra/features/uv:1": {},
        "ghcr.io/devcontainers/features/docker-in-docker:2": {},
        "./features/npm": {
            "version": "latest",
            "toolsToInstall": "npm,yarn,pnpm,@biomejs/biome@2.3.6,git-cz,npm-check-updates,@anthropic-ai/claude-code,@openai/codex"
        },
        "./features/cargo": {
            "toolsToInstall": "zellij,exa,bat,fd-find,ripgrep"
        },
        "./features/helix": {
            "version": "latest"
        },
        "./features/aws-sam-cli": {},
        "ghcr.io/anthropics/devcontainer-features/claude-code:1.0": {
            "installsAfter": [
                "./features/npm"
            ]
        },
        "ghcr.io/devcontainers-extra/features/aws-cdk:2": {}
    },
    "mounts": [
        // クラウドプロバイダーの認証情報をWindows/WSL2と共有.
        "source=${localEnv:HOME}${localEnv:USERPROFILE}/.aws,target=/home/vscode/.aws,type=bind,consistency=cached",
        "source=${localEnv:HOME}${localEnv:USERPROFILE}/.azure,target=/home/vscode/.azure,type=bind,consistency=cached",
        // Claude CodeやCodexの設定やキャッシュをWindows/WSL2と共有して複数のdevboxで使いまわす.
        "source=${localEnv:HOME}${localEnv:USERPROFILE}/.claude,target=/home/vscode/.claude,type=bind,consistency=cached",
        "source=${localEnv:HOME}${localEnv:USERPROFILE}/.codex,target=/home/vscode/.codex,type=bind,consistency=cached",
        // 依存関係のパッケージをキャッシュしておくことで、再インストールを高速化.
        "source=${localWorkspaceFolderBasename}-vite-pkgs,target=${containerWorkspaceFolder}/vite-serendie-template/node_modules,type=volume",
        "source=${localWorkspaceFolderBasename}-next-pkgs,target=${containerWorkspaceFolder}/next-daisyui-template/node_modules,type=volume",
        "source=${localWorkspaceFolderBasename}-python-pkgs,target=${containerWorkspaceFolder}/python-template/.venv,type=volume",
        // Serena MCPサーバのインデックスを保存.
        "source=${localWorkspaceFolderBasename}-serena,target=${containerWorkspaceFolder}/.serena/cache,type=volume"
    ],
    "remoteEnv": {
        "WORKSPACE_DIR": "${localWorkspaceFolderBasename}",
        "PATH": "/home/vscode/.local/bin:/home/vscode/.npx/bin:/home/vscode/.pnpx/bin:${containerEnv:PATH}"
    },
    "containerUser": "vscode",
    "initializeCommand": "bash ./.devcontainer/initialize.sh",
    "postCreateCommand": "bash ./.devcontainer/postCreate.sh",
    "postStartCommand": "bash ./.devcontainer/postStart.sh",
    "customizations": {
        "vscode": {
            "extensions": [
                // ===============
                // 基本拡張機能
                // ===============
                // "VisualStudioExptTeam.vscodeintellicode", // AIアシスト
                "ms-vsliveshare.vsliveshare", // コラボレーション
                "ms-vscode.copilot-mermaid-diagram",
                "vstirbu.vscode-mermaid-preview",
                "github.copilot", // Copilot Chat
                "github.copilot-chat", // Copilot Chat
                // ===============
                // コーディングエージェント
                // ===============
                "saoudrizwan.claude-dev", // Cline
                "anthropic.claude-code", // Claude Code
                "openai.chatgpt", // Codex
                // "continue.continue", // Continue
                // "tabnine.tabnine-vscode", // Tabnine
                // ===============
                // Python向け拡張機能
                // ===============
                "charliermarsh.ruff", // Formatter/Linter
                "ms-python.python", // Language support
                "ms-python.vscode-pylance", // Language server
                "ms-python.debugpy", // Debugger
                "njpwerner.autodocstring", // Docstring support
                // ==============
                // JavaScript/TypeScript向け拡張機能
                // ==============
                // "dbaeumer.vscode-eslint", // Linter
                // "esbenp.prettier-vscode", // Formatter
                "biomejs.biome", // Linter/Formatter
                "xabikos.JavaScriptSnippets", // Code Snippets
                // "yoavbls.pretty-ts-errors", // Pretty Error messages for Typescript
                "crystal-spider.jsdoc-generator", // JSDoc generator
                "formulahendry.auto-rename-tag", // Auto rename tag for HTML
                "formulahendry.auto-close-tag", // Auto close tag for HTML
                "dsznajder.es7-react-js-snippets", // Code Snippets for React.js
                // "PulkitGangwar.nextjs-snippets", // Code Snippets for Next.js
                // "nextnav.nextnav", // Route Visualizer for Next.js
                "wix.vscode-import-cost", // Package Size Checker for npm
                // ==============
                // MISC
                // ==============
                "github.vscode-github-actions", // GitHub Actions support
                "gitlab.gitlab-workflow", // GitLab CI/CD support
                // "ms-azuretools.vscode-docker", // Docker Support
                "tamasfe.even-better-toml", // TOML support
                "redhat.vscode-yaml", // YAML support
                "mhutchie.git-graph" // Git support
            ]
        }
    }
}
